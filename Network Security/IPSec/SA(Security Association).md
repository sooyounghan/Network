-----
### SA
-----
1. IPsec 데이터그램은 두 호스트, 두 라우터 또는 하나의 호스트와 하나의 라우터처럼 한 쌍의 네트워크 개체 사이에서 전송
2. IPsec 데이터그램을 전송하기 위해 출발지 개체와 목적지 개체는 네트워크 계층에서 논리적 연결을 설립하는데, 이 논리적 연결이 SA
3. SA는 단방향 연결이어서 출발지로부터 목적지 방향으로만 데이터가 흐를 수 있음
   - 두 개체가 서로에게 안전한 데이터그램을 전송하기 위해서는 2개의 SA(즉, 2개의 논리적 연결)가 양방향으로 하나씩 설립되어야 함
   - 예를 들어, 어떤 기관의 VPN을 생각 : 이 기관은 본부와 지점, 그리고 출장 중인 n명의 영업 직원들로 구성되고, 본부와 지점 사이에, 그리고 본부와 영업직원들 사이에 양방향의 IPsec 트래픽이 존재한다고 가정
     + 이 VPN에는 본부의 게이트웨이 라우터와 지점의 게이트웨이 라우터 사이에 2개 (한 방향으로 하나씩)의 SA가 존재, 본부와 영업직원들 랩톱 사이에도 2개(역시 한 방향으로 하나씩)의 SA가 존재
     + 따라서, SA의 총 개수는 (2 + 2n)
   - 💡 하지만 게이트웨이 라우터나 랩톱이 인터넷으로 보내는 모든 트래픽이 IPsec 방식으로 보호되지 않음
     + 예를 들어, 본부의 한 호스트는 공공 인터넷의 웹 서버에 접속하길 원할 수 있음
     + 그러므로 게이트웨이 라우터(그리고 랩톱)는 일반적인 IPv4 데이터그램과 IPsec 데이터그램 둘 다 인터넷으로 전송

4. SA 내부
<div align="center">
<img src="https://github.com/user-attachments/assets/b9917e58-9e64-47aa-ab24-62889d044a39">
</div>

   - R1에서 R2로 SA가 설립되어 있는 경우
   - 라우터 R1은 이 SA에 대해 다음과 같은 상태 정보 포함
     + SA에 대한 32비트 식별자인 SPI(Security Parameter Index)
     + SA 시작점의 인터페이스 (여기서는 ```200.168.1.100```)와 최종점의 인터페이스(```193.68.2.23```)
     + 사용되는 암호화 타입(예) CBC를 사용하는 3DES)
     + 암호화 키
     + 무결성 검사 타입 (예) MD5를 사용하는 HMAC)
     + 인증키
   - 라우터 R1이 이 SA로 보낼 IPsec 데이터그램을 생성할 때마다 어떻게 인증하고 암호화할지 결정하기 위해 상태 정보에 접근
   - 마찬가지로 라우터 R2 또한 이 SA에 대해 같은 상태 정보를 유지하고 SA를 통해 받은 IPsec 데이터그램을 인증하고 복호화하기 위해 지 정보를 사용

5. IPsec 개체(라우터 또는 호스트)는 종종 많은 수의 SA에 대해 상태 정보 유지
   - 예를 들어, VPN에 n명의 영업 직원이 있다면, 본부 게이트웨이 라우터는 (2 + 2n)개의 SA 상태 정보를 유지
   - IPsec 개체는 모든 SA에 대한 상태 정보를 그 개체의 OS 커널에 있는 SAD(Security Association Database)라는 데이터 구조에 저장
