-----
### IPsec 데이터그램
-----
1. IPsec은 터널 모드(Tunnel Mode)와 전송 모드(Transport Mode)라는 두 가지 패킷 형식을 가짐
   - VPN에 더 적합한 모드는 터널 모드로 널리 사용
2. IPsec 데이터그램 패킷 포맷
<div align="center">
<img src="https://github.com/user-attachments/assets/288f1ec2-b239-4007-8124-8a6492ac6148">
</div>

   - 라우터 R1이 호스트 ```172.16.1.17```(본부 네트워크에 있는)로부터 호스트 ```172.16.2.48```(지점 네트워크에 있는)로 향하는 일반적인 IPv4 데이터그램을 받았다고 가정
   - 라우터 R1은 이 원본 IPv4 데이터그램을 IPsec 데이터그램으로 변환하기 위해 다음 과정 이용
     + 원 IPv4 데이터그램(원래 헤더 필드 포함)의 뒤에 ESP 트레일러(Trailer)를 붙임
     + SA에 의해 지정된 알고리즘과 키를 이용해 위의 결과 암호화
     + 암호화된 결과 앞에 ESP 헤더를 덧붙임 : 이 패키지를 엔칠라다(Enchilada, 또띠아에 고기를 넣고 소스를 뿌린 멕시코 음식을 뜻함)
     + SA가 지정한 알고리즘과 키를 이용해 전체 엔칠라다에 대한 인증 MAC을 생성
     + 엔칠라다 뒤에 MAC을 붙여 페이로드를 만듬
     + 전형적인 IPv4 헤더 필드(보통 전부 협쳐 20바트 길이)를 가지고 완전히 새로운 IP 헤더를 만들어 위의 페이로드 앞에 붙임

  - 결과로 나온 IPsec 데이터그램은 전형적인 IPv4 헤더를 가지고 페이로드가 따라오는 진짜 IPv4 데이터그램
  - 그러나 이 경우에 페이로드는 ESP 헤더와 원래 IP 데이터그램, ESP 트레일러, ESP 인증 필드(원래 데이터그램과 ESP 트레일러가 암호화된 것) 포함
  - 원래 IP 데이터 그램은 출발지 IP 주소로 ```172.16.1.17```을, 목적지 IP 주소로 ```172.16.2.48```를 가지며, IPsec 데이터그램은 원래 IP 데이터그램을 포함하기 때문에 이 주소들도 IPsec 패킷 페이로드의 일부분으로 (암호화되어) 포함
  - 그러면 새로운 IP 헤더, 즉 IPsec 데이터그램 맨 왼쪽에 있는 헤더는 출발지와 목적지 IP 주소로 터널의 양 끝에 있는 출발지와 목적지의 라우터 인터페이스 주소 ```200.16.8.1.100```과 ```193.68.2.23```이 들어가게 됨
  - 또한, 새로운 IPv4 헤더 필드의 상위 프로토콜 필드값으로 TCP, UDP, SMTP 등을 나타내는 값이 사용되지 않고, ESP 프로토콜을 사용하는 IPsec 데이터그램임을 뜻하는 값 50 사용

3. R1이 공공 인터넷으로 전송한 IPsec 데이터그램은 R2에 도착하기 전에 많은 라우터를 통과할 것이고, 이들 라우터 각각은 이 데이터그램을 일반적인 데이터그램처럼 처리
   - 사실 이 데이터그램이 IPsec으로 암호화된 데이터를 갖고 있다는 사실을 전혀 모르며, 외부에 나타나 있는 헤더의 목적지 주소가 R2이므로 이러한 공공 인터넷 라우터들은 이 데이터그램 최종 목적지가 R2라고 생각

4. 엔칠라다의 구성 요소
   - ESP 트레일러는 패딩(Padding), 패딩 길이(Pad Length), 다음 헤더(Next Header)라는 3개의 필드로 구성
   - 패딩(의미 없는 바이트로 구성)은 원래 데이터그램(패딩 길이 필드와 다음 헤더 필드와 함께)에 덧붙여 최종 메세지가 정수개의 고정 길이 블록으로 분할 할 수 있게 함
   - 패딩 길이 필드는 얼마나 많은 패딩 비트가 삽입되었는지 (따라서, 얼마나 제거되어야 하는지) 수신 개체에게 알려주는 역할을 함
   - 다음 헤더 필드는 페이로드에 포함된 데이터의 타입(예) UDP)을 지시
   - 페이로드 데이터(일반적으로 원래 IP 데이터그램)와 ESP 트레일러는 이어 붙여진 후 암호화됨

5. 이렇게 암호화된 데이터 앞에 암호화되지 않은 형태로 전송되는 ESP 헤더가 존재하는데 2개의 필드가 존재(SPI, 순서 번호)
   - SPI : 수신 개체에게 데이터그램이 어느 SA에 속하는지 지시
   - 그러면 수신 개체는 해당 SPI를 가지고 자신의 SAD를 검색하여 알맞은 인증 및 복호화 알고리즘과 키를 결정
   - 순서 번호 필드 : 재생 공격에 대응하기 위해 사용

6. 송신 개체는 또한 인증 MAC를 덧붙임
   - 송신 개체는 전체 엔칠라다(ESP 헤더, 원 IP 데이터그램, ESP 트레일러 구성 - 데이터그램과 트레일러는 암호화됨)에 대해 MAC을 계산
   - MAC을 계산하기 위해 송신자는 비밀 MAC 키를 엔칠라다에 붙이고, 그 결과에 대해 고정 길이 해시 계산

7. R2가 IPsec 데이터그램을 받으면 R2는 데이터그램 목적지 IP가 R2 자신인지 살펴보고 그렇다면 데이터그램을 처리
   - 상위 프로토콜 필드(맨 왼쪽 IP 헤더에 있는) 값이 50이므로, R2는 데이터그램에 IPsec ESP 프로토콜을 적용해야 한다는 것을 알게 됨
   - 첫째, 엔칠라다를 들여다보고 R2는 SPI를 이용하여 데이터그램이 어느 SA에 속한 것인지 알아냄
   - 둘째, 엔칠라다의 MAC을 계산한 후 이것이 ESP MAC 필드 값과 일치하는지 확인
     + 일치한다면, R2는 이 엔칠라다가 R1으로부터 왔으며 중간에 조작되지 않음을 알 수 있음
   - 셋째, 데이터그램이 새것인지(재생된 데이터그램이 아닌지) 확인하기 위헤 순서 필드 검사
   - 넷쨰, SA와 관련된 복호화 알고리즘을 이용해 암호화된 부분 복호화
   - 다섯째, 패딩 비트를 삭제하여 원래 평범한 IP 데이터그래을 뽑아냄
   - 마지막으로, 원래의 IP 데이터그램을 최종 목적지로 전송하기 위해 지점 네트워크로 전송

8. R1이 본부 네트워크의 호스트로부터 (보안 처리되지 않은) 데이터그램을 받았고, 이 데이터그램이 본부 바깥의 네트워크를 목적지 주소로 갖고 있다고 할 때, R1은 어떻게 이 데이터그램이 IPsec 데이터그램으로 변환되는 것인지 아는 것과 IPsec에 의해 처리된다고 한다면 R1은 어떤 SA(SAD 내에 있는 많은 SA 중)를 사용해야하는지 아는 방법
   - IPsec 개체는 SAD와 함께 SPD(Security Policy Database)라 불리는 자료구조를 유지
   - 이 SPD는 어떤 형태의 데이터그램(출발지 IP 주소, 목적지 IP 주소, 프로토콜 타입 결정)이 IPsec으로 처리되어야 하는지와 그 때 사용할 SA 지시
   - 말하자면, SPD의 정보는 도착한 데이터그램으로 무엇을 할 것인지 알려주고, SAD 정보는 어떻게 할 것인지 알려줌

9. 요약
    - IPsec는 R1과 R2 사이 경로 어딘가에서 중간자 공격을 막기 위해 노리고 있는 중간 사용자 관점에서 보면 다음과 같음
    - 중간 사용자는 SA가 사용하는 인증 및 암호화 키를 모른다고 가정
    - 첫째, 중간 사용자는 원래 데이터그램을 볼 수 없으며, 데이터뿐만 아니라 프로토콜 넘버, 출발지 및 목적지 IP 주소도 볼 수 없으며, SA로 전송된 데이터그램에 대해 단지 호스트 ```200.168.1.100```에서 출발한 데이터그램이 호스트 ```193.68.2.23```으로 향한다는 사실만 알 수 있음
      + 데이터그램이 TCP 데이터를 담고 있는지, UDP 데이터를 담고 있는지, ICMP 데이터를 담고 있는지 알 수 없으며, 다른 타입의 애플리케이션 데이터를 담고 있는지 알 수 없음
      + 즉, 기밀성이 SSL의 경우보다 훨씬 발전
    - 둘째, 중간 사용자가 몇 비트를 바꿈으로 SA 데이터그램을 조작하려 한다고해도, R2에 도착하면 무결성 검사(MAC 사용)에 실패할 것
    - 셋째, 중간 사용자가 R1으로 가장하고 출발지를 ```200.168.1.100```으로, 목적지를 ```193.68.2.23```으로 하는 IPsec 데이터그램을 생성한다고 가정
      + 이 데이터그램은 다시 R2에서 무결성 검사를 통과하지 못할 것이므로 무용지물
    - 마지막으로, IPsec은 순서 번호를 가지므로 재생 공격에 성공할 수 없음
    - 즉, IPsec은 네트워크 계층의 패킷을 처리하는 어떤 장치들 사이에서도 기밀성, 출발지 인증, 데이터 무결성, 재생 공격에 대한 대응책 제공
