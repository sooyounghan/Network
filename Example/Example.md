-----
### 웹 페이지 요청
-----
-----
### DHCP, UDP, IP 그리고 인터넷
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/3503fe2d-b01a-4aa7-94ee-f0c0a207ef20">
</div>

1. 기본적인 상황
   - 랩톱을 켠 후 학교 이더넷 스위치(학교 라우터에 연결)에 연결되어 있는 이더넷 케이블에 연결
   - 학교 라우터는 ISP ```comcast.net```에 연결되어 있고, 이는 이 학교에 DNS 서비스 제공, DNS 서버는 학교 네트워크가 아닌 컴캐스트(Comcast) 네트워크에 있음
   - DHCP 서버는 실행되고 있다고 가정
   - 네트워크를 처음 랩톱에 연결하면 IP 주소 없이는 아무것도 할 수 없으므로, 랩톱이 네트워크 관련해 처음으로 취하는 행동은 DHCP 서버로부터 IP 주소를 획득하기 위해 DHCP 프로토콜 실행

2. 랩톱 운영체제는 DHCP 요청 메세지를 만들어 이 메세지를 목적지 포트 67(DHCP 서버)과 출발지 포트 68(DHCP 클라이언트)를 갖는 UDP 세그먼트에 넣음
   - UDP 세그먼트는 브로드캐스트 IP 목적지 주소(```255.255.255.255```)와 출발지 IP 주소 ```0.0.0.0```(아직 랩톱 IP 주소 없음)를 갖는 IP 데이터그램에 들어감

3. DHCP 요청 메세지를 포함한 IP 데이터그램은 이더넷 프레임에 들어감
   - 스위치에 연결된 모든 장치(DHCP 서버도 포함)에 이 프레임이 브로드캐스트될 수 있도록 이더넷 프레임 목적지 MAC 주소는 ```FF:FF:FF:FF:FF:FF```로 설정
   - 프레임의 출발지 MAC 주소는 랩톱의 MAC 주소인 ```00:16:D3:23:68:8A```

4. DHCP 요청 메세지를 포함한 브로드캐스트 이더넷 프레임은 랩톱이 처음으로 이더넷 스위치에 전송한 프레임
   - 스위치는 프레임을 자신의 모든 출력 포트(라우터로 연결된 포트 포함)로 브로드캐스트

5. 라우터는 MAC 주소 ```00:22:6B:45:1F:1B```인 인터페이스로 DHCP 요청 메세지가 포함된 브로드캐스트 이더넷 프레임을 수신
   - 이더넷 프레임으로부터 IP 데이터그램을 추출
   - 데이터그램의 브로드캐스트 IP 목적지 주소는 IP 데이터그램이 노드의 상위 계층 프로토콜에 의해 처리되어야 함을 의미
   - 데이터그램의 페이로드(UDP 세그먼트)가 UDP로 역다중화되고, UDP 세그먼트로부터 DHCP 요청 메세지가 추출될 수 있음
   - DHCP 서버는 DHCP 요청 메세지를 가짐

6. 라우터에서 실행되고 있는 DHCP 서버가 CIDR 블록 ```68.85.2.0/24```에 있는 IP 주소들을 할당할 수 있다고 가정
   - 학교에서 사용하는 모든 IP 주소는 컴캐스트 주소 블록 내 있는 것들임
   - DHCP 서버가 랩톱에게 주소 ```68.85.2.101```을 할당했다고 가정
   - DHCP 서버는 이 IP 주소와 DHCP 서버 IP 주소(```68.87.71.226```), 디폴트 게이트웨이 라우터 IP 주소(```68.85.2.1```), 서브넷 블록(```68.85.2.0/24```, 네트워크 마스크)을 포함하는 DHCP ACK 메세지를 만듬
   - DHCP ACK 메세지는 UDP 세그먼트에 들어가고, UDP 세그먼트는 IP 데이터그램에 들어가며, IP 데이터그램은 이더넷 프레임에 들어감
   - 이더넷 프레임은 출발지 MAC 주소로 홈 네트워크로의 라우터 인터페이스의 MAC 주소(```00:22:6B:45:1F:1B```)를, 목적지 MAC 주소로 랩톱의 MAC 주소(```00:16:ㅇ3:23:68:8A```)를 가짐

7. DHCP ACK 메세지를 포함한 이더넷 프레임은 라우터에 의해 스위치로 전송(유니캐스트)
   - 스위치는 자가학습을 하며 이전 랩톱으로부터 이더넷 프레임(DHCP 요청 메세지 포함)을 수신했기 때문에, ```00:16:D3:23:68:8A```를 목적지로 하는 프레임은 랩톱으로 가는 출력 포트로만 전달되어야 하는 것을 암

8. 랩톱은 DHCP ACK를 포함하는 이더넷 프레임을 수신한 후 이더넷 프레임으로부터 IP 데이터그램을 추출하고, IP 데이터그램으로부터 UDP 세그먼트를 추출하며, UDP 세그먼트로부터 DHCP ACK 메세지를 추출
   - DHCP 클라이언트는 자신의 IP 주소와 DNS 서버의 IP 주소 기록
   - 또한, IP 포워딩 테이블에 디폴트 게이트웨어 주소 저장
   - 랩톱은 자신이 속한 서브넷 ```68.85.2.0/24```의 외부를 목적지 주소로 하는 모든 데이터그램을 디폴트 게이트웨이로 보내게 됨
   - 이 시점에서 랩톱은 자신의 네트워크 구성요소들을 초기화하며, 웹 페이지 가져오기(Fetch)를 처리할 준비를 함

-----
### DNS, ARP
-----
1. 웹 브라우저에게 ```www.google.com``` URL를 입력하면 웹 브라우저에게 구글 홈페이지가 출력되도록 하는 긴 이벤트들이 시작
   - 웹 브라우저는 HTTP 요청 메세지를 보내기 위해 TCP 소켓을 생성하는 절차 시작
   - 소켓을 생성하기 위해 랩톱은 ```www.google.com```의 IP 주소를 알아야 하므로, DNS 프로토콜 사용

2. 랩톱 운영체제는 DNS 질의 메세지를 생성
   - 이 때, DNS 질의 메세지 질문 부분에 ```www.google.com```를 넣으며, DNS 질의 메세지는 목적지 포트가 53(DNS 서버)인 UDP 세그먼트에 들어감
   - UDP 세그먼트는 목적지 IP 주소 ```68.85.2.101```인 IP 데이터그램에 들어감
  
3. 랩톱은 DNS 질의 메세지가 포함된 데이터그램을 이더넷 프레임에 넣음
   - 이 프레임은 학교 네트워크에 있는 게이트웨이 라우터(링크 계층에서 주소가 주어짐)로 보내짐
   - 랩톱이 학교 게이트웨이 라우터 IP 주소 (```68.85.2.1```)를 5단계의 DHCP ACK 메세지를 통해 알게 되지만, 게이트웨이 라우터 MAC 주소를 알 수 없으므로, ARP 프로토콜 사용

4. 랩톱 목표 IP 주소 ```68.85.2.1``` (디폴트 게이트웨이)를 포함한 ARP 질의 메세지를 생성하며, ARP 메세지는 브로드캐스트 목적지 주소(```FF:FF:FF:FF:FF:FF```)를 갖는 이더넷 프레임에 포함되어 스위치로 전송
   - 스위치는 게이트웨이 라우터를 포함한 모든 연결된 장치로 프레임 전달

5. 게이트웨이 라우터는 학교 네트워크로의 인터페이스를 통해 ARP 질의 메세지를 포함하고 있는 프레임 수신
   - ARP 메세지로부터 목표 IP 주소 ```68.85.2.1```을 찾아 자신이 인터페이스의 IP 주소와 일치하는 것을 알게 됨
   - 따라서, 게이트웨이 라우터는 IP 주소 ```68.85.2.1```에 대응하는 MAC 주소 ```00:22:6B:45:1F:1B```를 포함한 ARP 응답 메세지를 생성
   - ARP 응답 메세지를 목적지 주소 ```00:16:D3:@3:68:8A```(랩톱)인 이더넷 프레임에 넣어 스위치로 보내며, 스위치는 프레임을 랩톱으로 전달

6. 랩톱은 ARP 응답 메세지가 포함된 프레임을 수신해 게이트웨이 라우터의 MAC 주소 (```00:22:6B:45:1F:1B```)를 추출

7. 랩톱은 게이트웨이 라우터의 MAC 주소로 DNS 질의 메세지가 포함된 이더넷 프레임 전송 가능
   - 프레임 목적지 주소가 ```00:22:6B:45:1F:1B```(게이트웨이 라우트)인 반면, 프레임에 포함된 IP 데이터그램의 IP 목적지 주소는 ```68.87.71.226```(DNS 서버)
   - 랩톱은 프레임을 스위치로 보내고, 스위치는 프레임을 게이트웨이 라우터로 전달

-----
### DNS 서버로의 인트라 도메인 라우팅
-----
1. 게이트웨이 라우터는 프레임을 받아 DNS 질의가 포함된 IP 데이터그램을 추출
   - 라우터는 데이터그램의 목적지 주소(```68.87.71.226```)를 포워딩 테이블에서 찾아서 데이터그램을 컴캐스트 네트워크 좌측 상단 라우터에 보내야 됨을 알게 됨
   - 학교 라우터를 좌측 상단 컴캐스트 라우터로 연결해주는 링크에 적합한 링크 게층 프레임에 IP 데이터그램을 넣은 후, 프레임을 해당 링크로 전송

2. 컴캐스트 네트워크의 좌측 상단 라우터는 프레임을 수신한 후, IP 데이터그램을 추출해서 데이터그램의 목적지 주소(```68.87.71.226```)와 포워딩 테이블(인터넷의 인터 도메인 프로토콜인 BGP와 RIP, OSPF 또는 IS-IS 같은 컴캐스트의 인트라 도메인 라우팅 프로토콜에 의해 결정)로부터 데이터 그램을 DNS 서버로 전달할 출력 인터페이스 결정
3. DNS 질의가 포함된 IP 데이터그램이 DNS 서버에 도착
   - DNS 서버는 DNS 질의 메세지를 추출한 후 DNS 데이터베이스에서 이름 ```www.google.com```을 찾아서 ```www.google.com```에 해당하는 IP 주소(```64.223.169.105```)를 포함하는 DNS 자원 레코드를 찾음 (DNS 서버에 DNS 자원 레코드가 현재 캐싱되었다고 가정)
   - 캐싱된 데이터는 ```www.google.com```에 대해 책임 DNS 서버가 준 것으로, DNS 서버는 호스트 이름에 대한 IP 주소 정보를 포함하는 DNS 응답 메세지를 만들어 UDP 세그먼트에 넣은 후, UDP 세그먼트를 랩톱(```68.85.2.101```)를 목적지로 하는 IP 데이터그램에 넣음
   - 이 데이터그램은 네트워크를 통해 학교 라우터로 가서 이더넷 스위치를 통해 랩톱으로 전달

4. 랩톱은 DNS 메세지로부터 서버 ```www.google.com```의 IP 주소를 추출하여 서버 접속

-----
### 웹 클라이언트-서버 상호작용 : TCP, HTTP
-----
1. 랩톱은 ```www.google.com```의 IP 주소를 알게 되었으며, HTTP GET 메세지를 보내는데 사용할 적절한 TCP 소켓 생성
   - TCP 소켓을 생성할 때 랩톱의 TCP는 ```www.google.com```에 있는 TCP와 세 방향 핸드쉐이크를 먼저 수행해야 함
   - 따라서, 랩톱은 먼저 목적지 포트 80(HTTP용)을 갖는 TCP SYN 세그먼트를 생성하고, TCP 세그먼트를 목적지 IP 주소가 ```64.223.169.105```(```www.google.com```)인 IP 데이터그램에 넣은 후, 데이터그램을 목적지 MAC 주소가 ```00:22:6B:45:1F:1B```(게이트웨이 라우터)인 프레임에 넣어 이 프레임을 스위치로 전송
  
2. 학교 네트워크, 컴캐스트 네트워크, 구글 네트워크에 있는 라우터들은 TCP SYN 세그먼트를 포함하고 잇는 데이터그램을 각 라우터의 포워딩 테이블을 사용해 ```www.google.com``` 쪽으로 전달
   - 컴캐스트와 구글 네트워크 사이의 도메인 간 링크상으로 패킷을 전달하는 데 사용되는 라우터의 포워딩 테이블 엔트리는 BGP 프로토콜에 의해 결정

3. TCP SYN 세그먼트를 포함하고 있는 데이터그램이 ```www.google.com```에 도착
   - TCP SYN 메세지는 데이터그램으로부터 추출되어 포트 80과 연관된 환영(Welcom) 소켓으로 역다중화
   - 연결 소켓은 구글 HTTP 서버와 랩톱 사이 TCP 연결을 위해 생성
   - TCP SYNACK 세그먼트를 생성해 랩톱을 목적지로 하는 데이터그램을 넣은 후, ```www.google.com```를 첫 홉 라우터로 연결해주는 링크에 적합한 링크 계층 프레임에 넣음

4. TCP SYNACK 세그먼트가 포함된 데이터그램은 구글, 컴캐스트, 학교 네트워크를 통해 랩톱의 이더넷 컨트롤러에 도착
   - 데이터그램은 TCP 소켓으로 운영체제에서 역 다중화(소켓은 연결된 상태)
  
5. 랩톱의 소켓은 바이트를 ```www.google.com```로 보낼 준비가 됐으며, 브라우저는 가져올 URL이 포함된 HTTP GET 메세지를 생성
   - HTTP GET 메세지를 소켓으로 보내며, HTTP GET 메세지는 TCP 세그먼트의 페이로드가 됨
   - TCP 세그먼트를 데이터그램에 넣어서 보내면 ```www.google.com```으로 전달

6. ```www.google.com```에 있는 HTTP 서버는 TCP 소켓으로부터 HTTP GET 메세지를 읽고, HTTP 응답 메세지를 생성하고 요청된 웹 페이지 컨텐츠를 HTTP 응답 메세지 바디에 포함시켜서 TCP 소켓으로 보냄

7. HTTP 응답 메세지를 포함하고 있는 데이터그램은 구글, 컴캐스트, 학교 네트워크를 통해 전달되어 랩톱에 도착
   - 웹 브라우저 프로그램은 소켓에서 HTTP 응답 메세지를 읽어, HTTP 응답 메세지의 바디로부터 웹 페이지에 대한 html 추출 후 웹 페이지를 출력
