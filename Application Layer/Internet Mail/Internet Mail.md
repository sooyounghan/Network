-----
### 인터넷 전자메일
-----
1. 전자메일을 비동기적인 통신 매체
2. 주요 요소 : 사용자 에이전트(User Agent), 메일 서버(Mail Server), SMTP(Simple Mail Transfer Protocol)
<div align="center">
<img src="https://github.com/user-attachments/assets/cef96192-bf75-42aa-9555-510f219195d0">
</div>

  - 사용자 에이전트는 사용자가 메세지를 읽고, 응답하고, 전달하고, 저장하고, 구성
  - 메일 서버는 전자메일 인프라스트럭쳐의 중심이며, 메일 박스를 가지고 있음
    + 서버로 전달할 수 없다면, 그 메세지를 메시지 큐(Message Queue)에 보관하고 나중에 그 메세지를 전달하기 위해 다시 시도
  - SMTP는 인터넷 전자메일을 위한 주요 애플리케이션 계층 프로토콜
    + 메일 송신자의 메일 서버로부터 수신자의 메일 서버로 전송하는 데 TCP의 신뢰적인 데이터 전송 서비스 이용
    + 송신자 메일 서버에서 수행하는 클라이언트와 수신자 메일 서버에서 수행되는 서버를 갖고 있는데, SMTP의 클라이언트와 서버 모두가 모든 메일 서버에서 수행
    + 메일 서버가 상대 메일 서버로 메일을 보낼 때 SMTP 클라이언트로 동작, 메일 서버가 상대 메일 서버로부터 메일을 받을 때는 SMTP 서버로 동작

-----
### SMTP
-----
1. RFC 5321로 정의되며, 송신자의 메일 서버로부터 수신자의 메일 서버로 메세지 전송
2. 모든 메일 메세지의 몸체(헤더뿐 아니라)는 단순히 7비트 ASCII 여야 한다는 단점 존재
   - 즉, SMTP 전송 후 ASCII를 다시 원래대로 변환해야 함
3. 예시
<div align="center">
<img src="https://github.com/user-attachments/assets/eb126cf9-bd62-413d-bb6e-988db3f02c38">
</div>

  - 전자메일 사용자 에이전트를 수행하고, 상대의 전자 메일주소를 제공하고, 메세지를 작성하고 사용자 에이전트에게 메세지를 보내라고 요청
  - 사용자 에이전트는 메세지를 메일 서버로 보내고, 그곳에서 메세지는 메시지 큥 놓임
  - 메일 서버에서 동작하는 SMTP 클라이언트 측은 메세지 큐에 있는 메세지를 보며, 메일 서버에서 수행되고 있는 SMTP 서버는 TCP 연결 설정
  - 초기 SMTP HandShaking 이후 SMTP 클라이언트는 메세지를 TCP 연결로 보냄
  - 상대는 메세지를 읽기 위해 사용자 에이전트 사용

4. 메일을 보낼 때, 두 메일 서버가 먼 거리에 떨어져 있더라도, 중간 메일 서버를 사용하지 않음
5. 클라이언트 SMTP(송신 메일 서버 호스트에서 수행)는 서버 SMTP(수신 메일 서버 호스트에서 수행)의 25번 포트로 TCP 연결 설정
   - 서버가 죽어있다면, 클라리언트는 나중에 다시 시도되며, 연결이 설정되면 서버와 클라이언트는 애플리케이션 계층 핸드쉐이킹 수행
   - SMTP 클라이언트와 서버는 정보를 전송하기 전 서로를 소개하며, SMTP 핸드쉐이킹 과정 동안 SMTP 클라이언트는 송신자의 전자메일 주소와 수신자의 메일 주소를 제공
     * 이 단계가 완료되면, 클라이언트는 메세지를 보내며, SMTP는 서버에 오류 없이 메세지를 전달하기 위해 TCP의 신뢰적인 데이터 전송 서비스에 의존하며, 서버에 보낼 다른 메세지가 있으면 클라이언트는 이 과정을 TCP 연결 상에서 반ㄴ복
     * 그렇지 않으면, TCP에게 연결을 닫을 것 명령
    
   - 예시
<div align="center">
<img src="https://github.com/user-attachments/assets/ae1f56d8-b4f0-48e0-a26d-9d4315a6bd99">
</div>

   - 클라이언트는 5개의 명령(HELO(HELLO), MAIL FROM, RCPT TO, DATA, QUIT) 전송
   - 클라이언트는 하나의 점(.)으로 된 라인 송신하며, 이는 서버에게 메세지의 끝을 나타냄
   - 서버는 각 명령에 응답하며, 각 응답에는 응답코드와 영문 설명(옵션) 존재 : SMTP는 지속 연결 사용
   - 송신 메일 서버가 같은 수신 메일 서버로 보내는 여러 메세지를 갖고 있다면, 같은 TCP 연결을 통해 모든 메세지 전달 가능

-----
### 메일 메세지 포맷
-----
1. RFC 5322에 정의되며, 헤더 라인과 메세지 몸체는 빈줄(CRLF)로 분리되며, 메일 헤더라인에 대한 정확한 포맷과 그 의미에 대한 해석 기술
2. HTTP와 같이 각 헤더라인은 키워드, 콜론, 값의 순서로 구성되고 읽을 수 있는 텍스트 포함
3. 모든 헤더는 From: 헤더 라인과 To: 헤더 라인을 반드시 가져야 함
4. 예시
<div align="center">
<img src="https://github.com/user-attachments/assets/d49467ed-5d19-4f35-a8d0-669b39e7814e">
</div>

  - 메세지 헤더 다음 빈 줄이 이어지고, 그 다음 메세지 몸체(ASCII 문자)가 나옴

-----
### 메세지 접속 프로토콜
-----
1. 메일 서버가 메일 박스를 관리하고 SMTP 클라이언트와 서버 측 모두를 수행
2. 일반 사용자는 로컬 호스트에서 사용자 에이전트를 수행하고 공유 메일 서버에 저장된 메일 박스에 접근하며, 메일 서버는 사용자들과 공유
3. 예시
<div align="center">
<img src="https://github.com/user-attachments/assets/bb2b6cbc-ae80-45e3-82bd-ab42b4e0441b">
</div>

   - 사용자 에이전트는 송신 메일 서버로 전자메일 메세지를 SMTP 또는 HTTP를 이용해 전송하며, 메일 서버는 SMTP(클라이언트 SMTP)를 사용하여 수신 메일 서버로 전자메일 메세지 중계
   - 메일 서버로 중계하지 않으면 송신 사용자 에이전트는 목적지 메일 서버에 도달 불가
   - 수신 사용자 에이전트는 메세지를 얻기 위해 SMTP 사용 불가(SMTP는 PUSH 프로토콜이며, 메세지를 얻는 것은 PULL 동작)
   - 해결 방법
     + 웹 기반 전자메일이나 스마트폰 앱의 경우 HTTP 사용 (메일 서버는 SMTP, HTTP 인터페이스를 갖고 있어야 함)
     + 전형적인 메일 클라이언트 사용은 RFC 3501에 정의된 IMAP(인터넷 메일 접근 프로토콜, Internet Mail Access Protocol) 사용
     + 두 방법 모두 수신 메일 서버에 의해 유지되는 폴더를 관리
