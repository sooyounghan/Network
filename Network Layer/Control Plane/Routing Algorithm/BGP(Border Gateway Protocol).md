-----
### BGP(Border Gateway Protocol, 경계 게이트웨이 프로토콜)
-----
1. 동일한 AS내 있는 출발지와 목적지 사이 패킷을 라우팅할 때, 패킷이 전송되는 경로는 전적으로 AS 내부 라우팅 프로토콜에 의해 결정
2. AS 간 라우팅 프로토콜은 여러 AS 간의 협력이 수반되므로 통신하는 AS들은 같은 AS 간 라우팅 프로토콜을 수행해야 함
   - 실제 인터넷의 모든 AS는 경계 게이트웨이 프로토콜(Border Gateway Protocol)이라고 불리는 동일한 AS 간 라우팅 프로토콜 사용
   - 이를 BGP라고 부름
3. BGP는 인터넷에 있는 수천 개의 ISP들을 연결하는 분산형 비동기식 프로토콜
4. BGP의 역할
   - AS와 그 AS 내 임의 라우터 가정
   - 라우터는 포워딩 테이블을 가지고 있는 도착한 패킷을 출력 링크로 보내는 중요 역할
   - 같은 AS 내에 있는 목적지에 대해서 라우터의 포워딩 엔트리들이 해당 AS와 AS 내부 라우팅 프로토콜에 의해 결정
  
5. 목적지가 AS 외부에 있는 경우 BGP가 필요
   - BGP에서는 패킷이 특정한 목적지 주소를 향해서가 아닌 CIDR(Classless Inter-Domain Routing) 형식으로 표현된, 주소의 앞쪽 프리픽스(Prefix)를 향해 전달
   - 각 프리픽스는 서브넷이나 서브넷의 집합을 나타냄
   - 예) 목적지가 ```136.16.68/22```와 같은 형식으로 표현되고, 1024개의 IP 주소를 포함
   - 여기서 라우터 포워딩 테이블은 (x, I)의 형식의 엔트리를 갖게 됨
     + x : 주소 프리픽스
     + I : 라우터 인터페이스의 인터페이스 번호

6. AS 간 라우팅 프로토콜로서 BGP의 수단
   - 이웃 AS를 통해 도달 가능한 서브넷 프리픽스 정보를 얻음
     + BGP는 각 서브넷이 자신의 존재를 인터넷 전체에 알릴 수 있도록 함
     + BGP는 인터넷 모든 라우터가 이 서브넷에 대해 알 수 있도록 만듬

   - 서브넷 주소 프리픽스로의 가장 좋은 경로 결정
     + 라우터는 특정 주소 프리픽스를 향한 2개 이상 경로 알 수 있음
     + 가장 좋은 경로를 결정하기 위해 라우터는 BGP의 경로 결정 프로시저(이웃 라우터를 통해 얻은 도달 가능 프리픽스 정보 이용)를 수행
     + 최고의 경로는 도달 가능 정보 뿐만 아니라 정책 기반으로 결정

-----
### BGP 경로 정보 알리기
-----
<div align="center">
<img src="https://github.com/user-attachments/assets/0a8970f0-7930-49cc-90f8-2754f20ce354">
</div>

1. 3개의 자율 시스템 AS1, AS2, AS3을 가지며, AS3은 주소 프리픽스가 x인 서브넷을 포함
   - 각 AS에서 각 라우터들은 게이트웨이 라우터 또는 내부 라우터
     + 게이트웨이 라우터 : AS 경계에 있는 라우터로서 다른 AS들에 있는 하나 또는 여러 개의 라우터와 직접 연결
     + 내부 라우터 : 자신의 AS 내에 있는 호스트 및 라우터와만 연결
   - AS1 라우터 1c는 게이트웨이 라우터, 라우터 1a, 1b, 1d는 내부 라우터

2. 프리픽스 x에 대한 도달 가능성 정보를 모든 라우터에게 알리는 작업
   - 먼저 AS3가 AS2에게 BGP 메세지를 보내 x가 존재하고 AS3내에 있음을 알림 : 'AS3 x'
   - AS2는 AS1에게 BGP 메세지를 보내서 x가 존재하고 x에 도달하기 위해 먼저 AS2를 통과하고 그 후 AS3에 갈 수 있음을 알림 : 'AS2 AS3 x'
   - 이런 방식으로 자율 시스템 각각은 x의 존재뿐 아니라, x에 이르기 위한 자율 시스템 경로를 알게 됨

3. 실제 자율 시스템은 메세지를 보내지 않고 라우터가 보냄
   - BGP에서 라우터의 쌍들은 포트 번호가 179이고, 반영구적인 TCP 연결을 통해 라우팅 정보를 교환
   - 이 TCP 연결을 통해 모든 BGP 메세지가 전송되는데 이 연결을 BGP 연결(BGP Connection)
   - 2개의 AS를 연결하는 BGP 연결 : 외부 BGP(External BGP, eBGP)
   - 같은 AS 내 라우터 간 BGP 연결 : 내부 BGP(Internal BGP, iBGP)
<div align="center">
<img src="https://github.com/user-attachments/assets/5c481c62-7049-4068-9cbf-accddddffb69">
</div>

   - 보통 각기 다른 AS에 속하는 게이트웨이 라우터를 직접 연결하는 링크에는 eBGP 연결이 존재
   - 게이트웨이 라우터 1c와 2a 간에, 2c와 3a 간에 eBGP 존재
   - 각 AS 내부 라우터 간에는 iBGP도 존재하는데, 각 AS 내에는 TCP 연결들이 그물이 만들어짐
   - 💡 iBGP 연결은 물리적 링크와 항상 일치하지 않음
   - 도달 가능성 정보를 전파하기 위해 iBGP와 eBGP 연결이 모두 사용
     + 프리픽스 x에 도달 가능 정보를 AS1와 AS2의 모든 라우터에게 알리는 경우
     + 게이트웨이 라우터 3a는 먼저 게이트웨이 라우터 2c에게 'AS3 x'라는 eBGP 메세지를 보냄
     + 그러면 게이트웨이 라우터는 2c는 iBGP 메세지 'AS3 x'를 게이트웨이 라우터 2a를 포함한 AS2 내부 모든 라우터에게 전송
     + 게이트웨이 라우터 2a는 eBGP 메세지 'AS2 AS3 x'를 게이트웨이 라우터 1c에게 보냄
     + 게이트웨이 라우터 1c는 iBGP를 사용하여 AS1 내 모든 라우터에게 메세지 'AS2 AS3 x'를 전달
     + 이 과정이 완료되면 AS1과 AS2의 각 라우터들은 x의 존재와 x로 향하는 AS 경로르 알게 됨

4. 물론 실제 네트워크에는 주어진 라우터에 특정 목적지까지 다른 많은 경로가 존재할 수 있고, 심지어 각기 다른 일련의 AS를 통과하기도 함
<div align="center">
<img src="https://github.com/user-attachments/assets/9ad3dbd6-49aa-4199-85c0-6b33c7be3656">
</div>

   - 네트워클 라우터 1d에서 3d로 연결하는 물리적 링크 추가
   - 이 경우 AS1에서 x로는 2개의 경로가 존재하는데, 라우터 1c를 통과하는 경로 'AS2 AS3 x'와 라우터 1d를 통과하는 새로운 경로 'AS3 x'
