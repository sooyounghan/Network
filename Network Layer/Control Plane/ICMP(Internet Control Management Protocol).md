-----
### 인터넷 제어 메세지 프로토콜 (ICMP)
-----
1. 호스트와 라우터가 서로 간에 네트워크 계층 정보를 주고받기 위해 사용
2. 가장 전형적인 사용 형태 : 오류 보고
   - 예를 들어, HTTP 연결을 수행할 때 '목적지 네트워크에 도달할 수 없음(Destination Network Unreachable)' 같은 오류 메세지 (ICMP가 만든 것으로, 네트워크 어떤 지점에서 IP 라우터가 HTTP 요청 메세지에 명시된 호스트로 가는 경로를 찾을 수 없음으로, 그 라우터가 호스트에게 오류 발생했음을 알리기 위해 ICMP 메세지를 만들어 보냄)

3. ICMP는 종종 IP의 한 부분으로 간주되지만, ICMP 메세지가 IP 데이터그램에 담겨 전송되므로 구조적으로는 IP 바로 위에 존재
   - 즉, TCP나 UDP 세그먼트가 IP 페이로드에 전송되는 것 처럼 ICMP 메세지도 IP 페이로드에 전송되는데, 비슷하게 호스트가 상위 계층 프로토콜이 ICMP라고 표시된(상위 계층 프로토콜 번호가 1번인) IP 데이터 그램을 받으면 TCP와 UDP를 데이터그램 내용으로 역다중화하는 것 처럼, ICMP로 내용을 역다중화

4. ICMP 메세지는 타입(type)과 코드(code) 필드가 있고, ICMP 메세지의 발생 원인이 된 IP 데이터그램의 헤더와 첫 8바이트를 가짐 (송신자가 오류를 발생시킨 패킷을 알 수 있도록 하기 위함)
<div align="center">
<img src="https://github.com/user-attachments/assets/2e513d01-811b-43bc-88eb-d4560a85c80b">
</div>

  - 💡 ICMP 메세지가 오류 상태를 알리기 위해서만 사용되는 것은 아님
  - 예시) ping 프로그램 (타입 8, 코드 0인 ICMP 메세지를 특정 호스트에 보냄)
    + 목적지 호스트는 에코 요청을 보고 나서 타입 0, 코드 0인 ICMP 에코 응답을 보냄
    + 대부분 TCP/IP 구현은 ping 서버를 운영체제에서 직접 지원 (즉, ping 서버는 별도 프로세스가 아님)
    + 클라이언트 프로그램은 운영체제에게 타입 8, 코드 0인 ICMP 메시지를 생성하도록 지시할 수 있어야 함

5. ICMP 메세지는 출발지 억제 메세지
   - 실제로는 잘 사용되지 않지만, 목적은 혼잡 제어 수행을 위한 것
   - 즉, 혼잡이 ㅂ라생한 라우터가 호스트의 전송 속도를 늦추도록 ICMP 출발지 억제 메세지를 해당 호스트에 보냄

6. 한 호스트에서 특정 호스트로의 경로를 추적하는 Traceroute 프로그램도 ICMP로 구현
   - 출발지와 목적지 사이 라우터 이름과 주소를 알아내기 위해 출발지의 Traceroute는 평범한 일련의 IP 데이터그램을 목적지에 보냄
   - 이 각 데이터그램은 UDP 포트 번호를 가진 UDP 세그먼트를 운반하며, TTL 값은 첫 번째 데이터그램이 1, 두 번째는 2, ... 로 구성
   - 출발지는 각 데이터그램에 대해 타이머를 작동시키며, n번쨰 데이터그램이 n번째 라우터에 도착하면 해당 라우터는 데이터그램의 TTL이 방금 만료되었음을 알게 됨
   - IP 프로토콜 규칙에 따라 라우터는 데이터그램을 폐기하며, ICMP 경고 메세지(타입 11, 코드 0)을 출발지에 전송하고, 이 경고 메세지는 라우터 이름과 IP 주소를 포함
   - ICMP 메세지가 출발지에 도착하면, 출발지는 타이머로부터 왕복 시간(RTT), ICMP 메세지로부터 n번째 라우터의 이름과 주소를 획득
   - Traceroute는 출발지가 자신이 보내는 각 데이터그램마다 차례로 TTL을 1씩 증가시키므로, 데이터그램 중 하나는 결국 목적지 호스트에 도착할 것
     + 데이터그램이 없을 것 같은 UDP 포트 번호를 가진 UDP 세그먼트를 포함하므로, 목적지 호스트는 포트 도달 불가능 ICMP(타입 3, 코드 3)를 출발지에 보냄
     + 출발지 호스트가 이 ICMP 메세지를 받게 되면 추가적인 탐색 패킷을 보낼 필요가 없음을 알게 됨
     + 표준 Traceroute 프로그램은 사실 같은 TTL을 가진 패킷을 3개씩 봬므로, 결과는 각 TTL에 대해 3개의 결과 제공

   - 이런 방식으로 출발지 호스트는 자신과 목적지 호스트 사이 라우터들의 수와 정체, 두 호스트 간 왕복 시간을 알게 됨
   - Traceroute 클라이언트 프로그램은 운영체제에게 특정 TTL 값을 가진 UDP 데이터그램을 생성하도록 지시할 수 있어야 하며, ICMP 메세지가 도착하면 운영체제가 이를 알리도록 할 수 있어야 함

  7. IPv6을 위한 새로운 ICMP 버전은 RFC 4443에 정의
     - 기존 ICMP 타입 및 코드 정의를 재구성하는 것 외에도 ICMPv6은 새로운 IPv6 기능에 필요한 새로운 타입과 코드도 추가
     - 여기에는 너무 큰 패킷(Packet Too Big)과 알 수 없는 IPv6 옵션 오류 코드 포함
