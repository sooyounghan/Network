-----
### 네트워크 주소 변환 (NAT, Network Address Translation)
-----
1. 모든 IP 활용 장치에는 IP 주소가 필요
   - SOHO(Small Office, Home Office) 네트워크 확산으로, SOHO가 장치를 연결하기 위해 LAN을 설치할 때 마다 모든 SOHO의 IP 장치를 수용할 수 있는 주소 범위 할당이 필요
   - 네트워크가 현저하게 커지면 큰 주소 블록이 할당되어야 함
   - 네트워크 주소 변환으로 주소 할당 가능

2. NAT 기능 라우터의 운영
<div align="center">
<img src="https://github.com/user-attachments/assets/fb7608df-9e07-4ac2-a629-fd620aa2af0d">
</div>

   - NAT 가능 라우터는 홈 네트워크의 일부인 인터페이스를 가짐
   - 홈 네트워크의 4개 인터페이스 모두 같은 네트워크 주소 ```10.0.0.0/24```를 가짐
   - 주소 공간 ```10.0.0.0/8```은 사설망(Private Network) 또는 홈 네트워크와 같은 사설 개인 주소를 갖는 권역(Realm)을 위해 예약된 IP 주소 공간 세 부분 중 하나
     + 사설 개인 주소를 갖는 권역이란 네트워크 주소들이 그 네트워크 내부에 있는 장비에게만 의미가 있는 네트워크를 의미
     + 수십만 개 홈 네트워크가 있고, 이 중 많은 네트워크가 같은 주소 공간 ```10.0.0.0/24```를 사용하고 있음을 생각할 때, 주어진 홈 네트워크 장비는 이 주소체계를 이용해 서로 패킷 송신 가능
     + 그러나 그 홈 네트워크를 벗어나 글로벌 인터넷으로 가는 패킷 전달은 이 주소들을 사용할 수 없는데, 이 주소들의 블록을 사용하는 수십만개의 네트워크가 존재하기 때문임
     + 즉, 이 주소들은 주어진 홈 네트워크에서만 의미가 있음
     + 패킷의 유일한 주소가 필요한 글로벌 인터넷과 송수신에서 처리하는 방법은 NAT에 있음

3. NAT 가능 라우터는 외부 세계에서는 라우터처럼 보이지 않고, 외부 세계로 하나의 IP 주소를 갖는 하나의 장비로 동작
   - 홈 라우터를 떠나 외부 인터넷으로 가는 트래픽은 출발지 IP 주소 ```138.76.29.7```을 가짐
   - 홈으로 들어오는 트래픽은 목적지 주소 ```138.76.29.7```을 가져야 함
   - 본질적으로 NAT 가능 라우터는 외부에서 들어오는 홈 네트워크의 상세한 사항을 숨김
     + 홈 네트워크 컴퓨터가 주소를 얻고, 라우터가 한 IP 주소를 어디서에서 얻는 것은 DHCP에서 수행함 : 라우터는 ISP의 DHCP 서버로부터 주소를 얻고, NAT-DHCP-라우터로 제어되는 홈 네트워크 주소 공간에서 DHCP 서버를 실행해 컴퓨터에게 주소 제공)
   - WAN에서 같은 목적지 IP 주소를 갖는 NAT 라우터(구체적으로 NAT 라우터의 WAN 쪽 인터페이스)에 모든 데이터그램이 도착하면, NAT 라우터에서 NAT 변환 테이블을 사용하고, 그 테이블에 IP 주소와 포트 번호를 포함하는 것

4. 사용자 입장에서 호스트 ```10.0.0.1```인 홈 네트워크가 IP 주소 ```128.119.40.186```인 웹 서버(포트 80)에게 웹 페이지를 요청한다고 가정
   - 호스트 ```10.0.0.1```는 임의의 출발지 포트 번호 3345를 할당하고 LAN에 데이터그램 전송
   - NAT 라우터는 데이터그램을 받아서, 데이터그램에 대한 새로운 출발지 포트 번호 5001를 생성하고, WAN쪽 IP 주소 ```138.76.29.7```과 출발지 IP 주소를 변경하고, 새 출발지 포트 번호 5001과 원래 출발지 포트 번호 3345를 변경
   - 새 출발지 포트 번호를 생성할 때, NAT 라우터는 NAT 변환 테이블에 없는 모든 출발지 포트 번호를 선택할 수 있음 (포트 번호의 필드가 16비트로 길기 때문에, NAT 프로토콜은 라우터에 대한 WAN 쪽 IP 주소에 대해 60000개 이상 동시 접속 지원)
   - 라우터 내부 NAT에는 NAT 변환 테이블의 엔트리도 추가되며, NAT 라우터에 의해 처리된 HTTP 요청이 들어있는 데이터그램 도착을 의식하지 모한 웹 서버는 NAT 라우터의 IP 주소 목적지 주소와 5001인 목적지 포트 번호에 대해 응답
   - 이 데이터그램이 NAT 라우터에 도착했을 때, 라우터는 홈 네트워크 브라우저 IP 주소(```10.0.0.1```)와 목적지 포트 번호(3345)로부터 얻은 목적지 IP 주소와 목적지 포트 번호를 사용해 NAT 변환 테이블을 작성
   - 라우터는 데이터그램 목적지 주소와 포트 번호를 다시 기록하고, 홈 네트워크 내부로 데이터그램 전달

5. 포트 번호가 호스트 주소 지정이 아닌 프로세스 주소 지정에 사용되는 점을 주의
   - P2P의 경우 서버 프로세스는 잘 알려진 포트 번호에서 요청이 올 때까지 기다리고, P2P 프로토콜의 피어는 서버로서의 역할을 할 때 들어오는 연결을 수락해야 하므로 홈 네트워크에서 실행되는 서버에 문제 발생이 가능
   - 즉, 한 피어가 NAT 서버 뒤에 있고, DHCP 제공 NAT 주소가 다른 피어에 연결된 경우, 이를 해결하기 위해 NAT 순회 도구를 사용
   - NAT는 IP 주소를 수정하는 노드를 간섭하지 않고 포트 수보다 훨씬 적은 호스트가 서로 직접 소통해야 한다는 원칙 위반
